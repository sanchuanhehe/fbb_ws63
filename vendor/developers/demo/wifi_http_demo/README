# å‰è¨€

æœ¬ç³»åˆ—æ—¨åœ¨ä»åµŒå…¥å¼æ–°æ‰‹å°ç™½çš„è§†è§’ï¼Œä½¿ç”¨æ˜Ÿé—ªWS63ä¸ºä¸»æ§ä½œä¸ºå…¥é—¨å¼€å‘æ¿ï¼Œæå‡å¤§å®¶çš„åµŒå…¥å¼å¼€å‘æ°´å¹³ã€‚å¦‚æœåœ¨å­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œæ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼äº¤æµï¼š
- æ–‡ç« ç•™è¨€åŒºæé—®
- ç§ä¿¡ä½œè€…
- æµ·æ€ç¤¾åŒºå‘å¸–è®¨è®º

> **æœ¬æœŸæ¡ˆä¾‹**
> - åŸºäºWiFi STAæ¨¡å¼è¿æ¥2.4GHzç½‘ç»œï¼Œå®ŒæˆHTTP Getè¯·æ±‚å¤©æ°”é¢„æŠ¥ï¼Œå¹¶è¿›è¡Œjsonæ ¼å¼è§£æã€‚
> 
> **ç³»åˆ—é¢„å‘Š**ï¼š
> - WS63 WiFi APæ¡ˆä¾‹æ•™å­¦
> - WS63å¤–è®¾æ•™å­¦
> - æ˜Ÿé—ªåè®®æ ˆæ·±åº¦è§£æ

---

# æ ¸å¿ƒä»£ç è§£æ

**æ­¤å¤„ä»…å«å…³é”®ä»£ç çš„è§£æéƒ¨åˆ†ï¼Œå®Œæ•´ä»£ç è¯·åœ¨ gitee ä¸Šæœç´¢ Adragon/fbb_ws63ï¼Œæ¡ˆä¾‹ä»£ç å­˜æ”¾åœ¨[vendor/developers/demo/wifi_http_demo](https://gitee.com/AdragonGit/fbb_ws63/tree/master/vendor/developers/demo/wifi_http_demo)ã€‚**

## WiFi STA è¿æ¥æ¨¡å—ï¼š

æ­¤éƒ¨åˆ†è®²è§£å¦‚ä½•å°†[WS63çš„WiFi STA Sampleæºç ](https://gitee.com/HiSpark/fbb_ws63/blob/master/src/application/samples/wifi/sta_sample/sta_sample.c)ä¿®æ”¹æˆä¸€ä»½ API æ¥å£ã€‚

### 1.APIæ¥å£è®¾è®¡

åœ¨ example_get_match_network å‡½æ•°ä¸­æ·»åŠ  ssid å’Œ psk ä¸¤ä¸ªå‚æ•°ï¼Œæ³¨é‡Šæ‰å‡½æ•°åŸæœ‰çš„ td_char ssid å’Œ td_char key ä¸¤ä¸ªå‚æ•°ï¼Œå¹¶å°†è°ƒç”¨åˆ°çš„åŸå‚æ•°ä¿®æ”¹æˆå‡½æ•°å£°æ˜ä¸­æ·»åŠ çš„ ssid å’Œ psk å‚æ•°ã€‚

```
/*****************************************************************************
  STA åŒ¹é…ç›®æ ‡ APï¼ˆå‚æ•°åŒ–æ”¹é€ ï¼‰
*****************************************************************************/
td_s32 example_get_match_network(wifi_sta_config_stru *expected_bss, const char *ssid, const char *psk)
{
    td_s32 ret;
    td_u32 num = 64; /* 64:æ‰«æåˆ°çš„Wi-Fiç½‘ç»œæ•°é‡ */
    // td_char ssid[] = "test";
    // td_char key[] = "123456789"; /* å¾…è¿æ¥çš„ç½‘ç»œæ¥å…¥å¯†ç  */
    td_bool find_ap = TD_FALSE;
    td_u8 bss_index;
    /* è·å–æ‰«æç»“æœ */
    td_u32 scan_len = sizeof(wifi_scan_info_stru) * WIFI_SCAN_AP_LIMIT;
    wifi_scan_info_stru *result = osal_kmalloc(scan_len, OSAL_GFP_ATOMIC);
    if (result == TD_NULL) {
        return -1;
    }
    memset_s(result, scan_len, 0, scan_len);
    ret = wifi_sta_get_scan_info(result, &num);
    if (ret != 0) {
        osal_kfree(result);
        return -1;
    }
    /* ç­›é€‰æ‰«æåˆ°çš„Wi-Fiç½‘ç»œï¼Œé€‰æ‹©å¾…è¿æ¥çš„ç½‘ç»œ */
    for (bss_index = 0; bss_index < num; bss_index++) {
        if (strlen(ssid) == strlen(result[bss_index].ssid)) {
            if (memcmp(ssid, result[bss_index].ssid, strlen(ssid)) == 0) {
                find_ap = TD_TRUE;
                break;
            }
        }
    }
    /* æœªæ‰¾åˆ°å¾…è¿æ¥AP,å¯ä»¥ç»§ç»­å°è¯•æ‰«ææˆ–è€…é€€å‡º */
    if (find_ap == TD_FALSE) {
        osal_kfree(result);
        return -1;
    }
    /* æ‰¾åˆ°ç½‘ç»œåå¤åˆ¶ç½‘ç»œä¿¡æ¯å’Œæ¥å…¥å¯†ç  */
    if (memcpy_s(expected_bss->ssid, WIFI_MAX_SSID_LEN, ssid, strlen(ssid)) != 0) {
        osal_kfree(result);
        return -1;
    }
    if (memcpy_s(expected_bss->bssid, WIFI_MAC_LEN, result[bss_index].bssid, WIFI_MAC_LEN) != 0) {
        osal_kfree(result);
        return -1;
    }
    expected_bss->security_type = result[bss_index].security_type;
    if (memcpy_s(expected_bss->pre_shared_key, WIFI_MAX_SSID_LEN, psk, strlen(psk)) != 0) {
        osal_kfree(result);
        return -1;
    }
    expected_bss->ip_type = 1; /* 1ï¼šIPç±»å‹ä¸ºåŠ¨æ€DHCPè·å– */
    osal_kfree(result);
    return 0;
}
```

### 2.è¿æ¥è°ƒç”¨å®ä¾‹ï¼š

åˆ›å»º wifi_connect(const char *ssid, const char *psk)API æ¥å£ï¼Œåªéœ€è¦è°ƒç”¨è¯¥å‡½æ•°ä¾¿å¯ä»¥è¿æ¥WiFiã€‚

```C
/*****************************************************************************
  è¿æ¥ WiFi çš„ API å‡½æ•°
*****************************************************************************/
void wifi_connect(const char *ssid, const char *psk)
{
    /* æ³¨å†Œäº‹ä»¶å›è°ƒ */
    if (wifi_register_event_cb(&wifi_event_cb) != 0) {
        osal_printk("%s::wifi_event_cb register fail.\r\n", WIFI_STA_SAMPLE_LOG);
        return -1;
    }
    osal_printk("%s::wifi_event_cb register succ.\r\n", WIFI_STA_SAMPLE_LOG);

    /* ç­‰å¾…wifiåˆå§‹åŒ–å®Œæˆ */
    while (wifi_is_wifi_inited() == 0) {
        (void)osDelay(10); /* 1: ç­‰å¾…100msååˆ¤æ–­çŠ¶æ€ */
    }
    osal_printk("%s::wifi init succ.\r\n", WIFI_STA_SAMPLE_LOG);

    if (example_sta_function(ssid, psk) != 0) {
        osal_printk("%s::example_sta_function fail.\r\n", WIFI_STA_SAMPLE_LOG);
        return -1;
    }
    return 0;
}

#è¿æ¥WiFiè°ƒç”¨å®ä¾‹
#define CONFIG_WIFI_SSID "Your_SSID"        // è¦è¿æ¥çš„WiFi çƒ­ç‚¹è´¦å·
#define CONFIG_WIFI_PWD "Your_PWD"          // è¦è¿æ¥çš„WiFi çƒ­ç‚¹å¯†ç 
void main() {
    wifi_connect(CONFIG_WIFI_SSID, CONFIG_WIFI_PWD);
}
```

## HTTP é€šä¿¡æ¨¡å—ï¼š
æ­¤éƒ¨åˆ†è®²è§£å¦‚ä½•è§£æHTTP Getè¯·æ±‚çš„URLã€æœåŠ¡å™¨IPä¸ç«¯å£ã€‚

### å…³é”®å‚æ•°è·å–æŒ‡å—ï¼š
1. **è·å–URLè¿æ¥**ï¼š

- ç½‘ç«™çš„APIæ¥å£æ–‡æ¡£ï¼šæœ¬æ¬¡è¯·æ±‚çš„[å¤©æ°”é¢„æŠ¥ç½‘ç«™â€”â€”ä¸«ä¸«å¤©æ°”](http://www.yytianqi.com/api.html)ä¸­ï¼Œä¾¿æä¾›äº†APIé€šç”¨æ ¼å¼ï¼Œä¹Ÿå°±æ˜¯URLé“¾æ¥ã€‚
  
![ä¸«ä¸«å¤©æ°”APIä»‹ç»å›¾](https://i-blog.csdnimg.cn/img_convert/8827e5889bb2ab12bb251811ed22a7eb.png)
- å¼€å‘è€…å·¥å…·ï¼š"Ctrl+Shift+I"æˆ–è€…"é¼ æ ‡å³é”®+æ£€æŸ¥"ï¼Œåˆ‡æ¢åˆ°"ç½‘ç»œ"æˆ–è€…"å…ƒç´ "ä¸­ï¼Œåˆ·æ–°é¡µé¢å¹¶æŸ¥çœ‹åŠ è½½çš„èµ„æºï¼Œå…¶ä¸­åŒ…å«è¯·æ±‚Urlã€‚
  
![å¼€å‘è€…å·¥å…·æŸ¥æ‰¾URLç¤ºæ„å›¾](https://i-blog.csdnimg.cn/img_convert/69ea94ef7520bb5d7211da321430c2ec.png)
- è·å–åˆ°URLåï¼Œå¯ä»¥å…ˆä½¿ç”¨Postmanç­‰å·¥å…·è¿›è¡Œæµ‹è¯•ï¼Œæˆ–è€…ç›´æ¥æœç´¢URLè¿›è¡Œæµ‹è¯•ï¼Œéšåå†å†™å…¥ä»£ç ä¸­ã€‚

![ç›´æ¥æœç´¢URLç¤ºæ„å›¾](https://i-blog.csdnimg.cn/img_convert/4752bccb7e717f885f12f4de11ed243a.png)

2.**è·å–æœåŠ¡å™¨IP**
  - å‘½ä»¤è¡ŒæŸ¥è¯¢IPï¼š
  ```powershell
   ping <æœåŠ¡å™¨åŸŸå>       #æŒç»­è¯·æ±‚æœåŠ¡å™¨
   ping -n 4 <æœåŠ¡å™¨åŸŸå>  #Windowsç³»ç»Ÿè¯·æ±‚4æ¬¡æœåŠ¡å™¨
   ping -c 1 <æœåŠ¡å™¨åŸŸå>  #Linux/macOSç³»ç»Ÿè¯·æ±‚1æ¬¡æœåŠ¡å™¨
   å¦‚ï¼šping api.yytianqi.com
  ```
  
![](https://i-blog.csdnimg.cn/img_convert/bbf16b09b853613536cf1510d6bb75b7.png)

 3.**å¸¸ç”¨ç«¯å£**ï¼š
 
 HTTPåè®®é»˜è®¤ç«¯å£ä¸º80ï¼ŒHTTPSåè®®é»˜è®¤ç«¯å£ä¸º443ã€‚

### æ¡ˆä¾‹ä»£ç 
```C
#include "http.h"
#include "weather.h"

#define CONFIG_SERVER_PORT 80            // è¦è¿æ¥çš„æœåŠ¡å™¨ç«¯å£
#define CONFIG_SERVER_IP "123.57.54.168" // è¦è¿æ¥çš„æœåŠ¡å™¨IP

//URLé“¾æ¥ï¼šhttp://api.yytianqi.com/observe?city=CH280601&key=62w9bk1okpme4k59
static const char *g_request = "GET /observe?city=CH280601&key=62w9bk1okpme4k59 HTTP/1.1\r\n"
                               "Host: api.yytianqi.com\r\n"
                               "Connection: close\r\n"
                               "\r\n";

/* HTTP Getè¯·æ±‚ */
void http_client_get(void *param) {
    param = param; 
    struct sockaddr_in addr = {0};
    int s, r;
    char recv_buf[HTTPC_DEMO_RECV_BUFSIZE];

    /* wifi_connect */
    osal_printk("*****Connect to WiFi: ");
    osal_printk(CONFIG_WIFI_SSID);
    osal_printk("*****\r\n");
    wifi_connect(CONFIG_WIFI_SSID, CONFIG_WIFI_PWD);

    addr.sin_family = AF_INET;
    addr.sin_port = PP_HTONS(CONFIG_SERVER_PORT);
    addr.sin_addr.s_addr = inet_addr(CONFIG_SERVER_IP);
    s = socket(AF_INET, SOCK_STREAM, 0);
    osal_printk("s = %d\r\n", s);
    if (s < 0) {
        return 1;
    }

    /* socketè¿æ¥æœåŠ¡å™¨ */ 
    osal_printk("NO1:... allocated socket\r\n");
    if (connect(s, (struct sockaddr *)&addr, sizeof(addr)) != 0) {
        osal_printk("... socket connect failed errno=%d", errno);
        lwip_close(s);
        return 1;
    }
    osal_printk("NO2:... connected\r\n");
    
    /* å‘é€HTTP GETè¯·æ±‚ */
    if (lwip_write(s, g_request, strlen(g_request)) < 0) {
        lwip_close(s);
        return 1;
    }
    osal_printk("NO3:... socket send success\r\n");

     /* 5S Timeout */
    struct timeval receiving_timeout;
    receiving_timeout.tv_sec = 5;
    receiving_timeout.tv_usec = 0;
    if (setsockopt(s, SOL_SOCKET, SO_RCVTIMEO, &receiving_timeout, sizeof(receiving_timeout)) < 0) {
        osal_printk("... failed to set socket receiving timeout\r\n");
        lwip_close(s);
        return 1;
    }
    osal_printk("NO4:... set socket receiving timeout success\r\n");

     /* è¯»å– HTTP Response å†…å®¹ */
    do {
        (void)uapi_watchdog_kick();
        (void)memset_s(recv_buf, sizeof(recv_buf), 0, sizeof(recv_buf));
        r = lwip_read(s, recv_buf, sizeof(recv_buf) - 1);
        osal_printk("r = %d\r\n", r);
        if (r <= 0) {
            osal_printk("lwip_read Done!\r\n");
            break;
        }

        /* è¾“å‡º HTTP Response å†…å®¹ */
        for (int i = 0; i < r; i++) {
            osal_printk("%c", recv_buf[i]);
        }

        /* è§£æå¹¶è¾“å‡ºå¤©æ°”ã€é£åŠ›ã€é£å‘ã€åŸå¸‚åç§°ã€æ—¶é—´å’Œç›¸å¯¹æ¹¿åº¦ */ 
        parse_weather_data(recv_buf);
    } while (r > 0);

    osal_printk("...done reading from socket. Last read return=%d, errno=%d\r\n", r, errno);
    lwip_close(s);

    return 0;
}
```

## Weather Json è§£æ
æ­¤éƒ¨åˆ†ä¸»è¦ä¸ºè§£æå¤©æ°”é¢„æŠ¥è¿”å›çš„jsonæ ¼å¼æ•°æ®ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹[ä»£ç ä»“å†…å®¹](https://gitee.com/AdragonGit/fbb_ws63/tree/master/vendor/developers/demo/wifi_http_demo)ã€‚

## å¸¸è§é—®é¢˜æ’æŸ¥
| ç°è±¡ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| WiFiè¿æ¥è¶…æ—¶ | 1. ç¡®è®¤2.4GHzç½‘ç»œ<br>2. æ£€æŸ¥å¯†ç é•¿åº¦ |
| HTTP 404é”™è¯¯ | 1. éªŒè¯APIæ‹¼æ¥æ ¼å¼<br>2. æ£€æŸ¥g_requestå‚æ•°è§£ææ ¼å¼ |
| JSONè§£æå¤±è´¥ | 1. æ‰“å°åŸå§‹æ•°æ®<br>2. ä½¿ç”¨åœ¨çº¿JSONéªŒè¯å·¥å…· |

---

# åŠŸèƒ½æ‹“å±•

æœ¬æ–‡ä½¿ç”¨äº†WiFi STAæ¨¡å¼å’ŒHTTP Getè¯·æ±‚è·å–å¤©æ°”é¢„æŠ¥ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚åˆ©ç”¨è¿™ä¸¤ä¸ªæ¨¡å—å¼€å‘å…¶ä»–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ç”¨HTTP Getè¯·æ±‚è·å–å…¶ä»–æœåŠ¡å™¨ä¿¡æ¯ã€æ•°æ®æµã€‚

# æ€»ç»“

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæ‚¨å·²å®Œæˆï¼š
- WiFi STA è¿æ¥ âœ”ï¸
- HTTP Get è¯·æ±‚ âœ”ï¸
- Jsonæ ¼å¼æ•°æ®è§£æ âœ”ï¸

**ä¸‹æœŸèšç„¦**ï¼š  
ğŸ”¥ æ˜Ÿé—ªWS63 WiFi APæ¡ˆä¾‹æ•™å­¦å®æˆ˜  
ğŸ”¥ æ˜Ÿé—ªWS63å¤–è®¾æ•™å­¦  
ğŸ”¥ æ˜Ÿé—ªåè®®æ ˆæ·±åº¦è§£æ  

> **å¼€å‘ç®´è¨€**ï¼š  
> å½“é‡åˆ°HTTPé€šä¿¡é—®é¢˜æ—¶ï¼Œç‰¢è®°ä¸‰ä¸ªæ£€æŸ¥ç‚¹ï¼š  
> 1. ç½‘ç»œè¿æ¥çŠ¶æ€  
> 2. è¯·æ±‚å¤´å®Œæ•´æ€§ï¼Œæ˜¯å¦éœ€è¦è¿‡æ»¤è¯·æ±‚å¤´  
> 3. æœåŠ¡å™¨å“åº”ç ï¼Œæ ¹æ®å“åº”ç è¿›è¡Œè°ƒè¯• 

æ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„å¤©æ°”ç«™åˆ›æ„ï¼Œå®Œæ•´ä»£ç è·å–ï¼š[Giteeä»£ç ä»“](https://gitee.com/AdragonGit/fbb_ws63/tree/master/vendor/developers/demo/wifi_http_demo)